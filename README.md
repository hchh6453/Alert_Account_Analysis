# 金融交易異常檢測系統

## 🎯 專案目標
從龐大且關係複雜的轉帳交易資料中，找出不合理的交易模式，分析交易時間線、金額以及交易對手，預測未來會被判定為警示的帳戶。

## 📊 評估指標
- **F1-score**: 主要評估指標
- **TP (True Positive)**: 該帳戶實際為警示帳戶，預測為警示帳戶
- **FN (False Negative)**: 該帳戶實際為警示帳戶，預測為正常帳戶  
- **FP (False Positive)**: 該帳戶實際為正常帳戶，預測為警示帳戶
- **TN (True Negative)**: 該帳戶實際為正常帳戶，預測為正常帳戶

## 🏗️ 系統架構

### 核心模組
- `data_loader.py`: 資料載入與預處理
- `alert_focused_feature_engineering.py`: 警示帳戶特徵工程
- `incremental_learning.py`: 增量學習主程式（主要執行檔）

### 資料檔案
- `data/acct_alert.csv`: 已知警示帳戶標籤 (1,500個)
- `data/acct_predict.csv`: 需要預測的帳戶 (4,780個)
- `data/acct_transaction.csv`: 交易記錄 (4,435,890筆)

## 🔄 增量學習邏輯

### 1. 訓練資料創建
```python
# 當前設定
alert_ratio=0.1         # 10% 警示帳戶
sample_size=5000        # 5000 個訓練樣本
strategy='representative'  # 代表性採樣：確保涵蓋不同交易模式
```

**採樣策略**：
- **警示帳戶**: 採樣 500 個 (10%)
- **正常帳戶**: 採樣 4,500 個 (90%)
- **代表性採樣**: 從 1,794,322 個正常帳戶中，按交易金額分組，確保涵蓋不同交易模式

### 2. 模型訓練與比較
系統會訓練以下模型並比較其 F1-score：
- **Random Forest**: 監督學習，使用交叉驗證
- **Isolation Forest**: 無監督異常檢測
- **One-Class SVM**: 無監督學習
- **LOF**: 基於密度的異常檢測
- **DBSCAN**: 聚類異常檢測

### 3. 最佳模型選擇
- 使用已知標籤資料（5000個樣本）進行模型比較
- 選擇 F1-score 最高的模型
- 用此模型預測所有未標籤帳戶

### 4. 批次預測
- 將 4,780 個預測帳戶分批處理
- 每批 1,000 個帳戶（記憶體管理）
- 確保 100% 覆蓋率

## 🎯 特徵工程

### 警示帳戶導向特徵（從 EDA 發現）
- **時間特徵**: 
  - 週末交易比例、夜間交易比例
  - 交易間隔變異性（警示帳戶間隔更不規則）
- **金額特徵**: 
  - 相同金額頻率（警示帳戶常有重複金額）
  - 金額標準差、最大最小金額
- **對手特徵**: 
  - 轉入多樣性（警示帳戶轉入對手少）
  - 獨特交易對手數量
- **行為特徵**: 
  - 交易頻率、交易模式
  - 異常檢測分數
- **風險特徵**: 
  - 綜合風險評分

## 📈 當前問題與改善策略

### 🚨 當前表現
- **F1-score**: 0.1335（系統評測）
- **預測警示帳戶比例**: 42.74% (2,043/4,780)
- **真實警示帳戶比例**: 約 0.1%
- **主要問題**: Random Forest 預測過多警示帳戶，導致 Precision 極低

### 💡 改善策略

#### 策略 1: 大幅降低訓練比例 🎯
```python
alert_ratio=0.001  # 0.1% 警示帳戶（接近真實比例）
```
- **原因**: 當前 10% vs 真實 0.1%，差距 100 倍
- **預期效果**: 降低預測警示帳戶比例到 1% 以下

#### 策略 2: 移除類別權重平衡 ⚖️
```python
# Random Forest 不使用 class_weight='balanced'
# 讓模型學習真實的類別分布
```
- **原因**: `class_weight='balanced'` 會過度補償少數類
- **預期效果**: 減少 False Positive

#### 策略 3: 調整模型參數 🔧
```python
# Random Forest 參數
n_estimators=50      # 降低（當前 100）
max_depth=3          # 降低（當前 10）
min_samples_leaf=20  # 提高（當前 5）
```
- **原因**: 減少過擬合
- **預期效果**: 更好的泛化能力

#### 策略 4: 增加訓練樣本 📊
```python
sample_size=10000  # 提高到 10000
```
- **原因**: 學習更全面的正常帳戶模式
- **預期效果**: 減少誤判正常帳戶

#### 策略 5: 優先使用無監督學習 🤖
- **Isolation Forest**: 專門設計用於異常檢測，不受類別分布影響
- **One-Class SVM**: 學習正常模式，異常自動識別
- **LOF**: 基於密度，對異常敏感
- **原因**: 監督學習在極度不平衡時表現差
- **預期效果**: F1-score 提升到 0.3-0.4

## 🚀 執行方式

### 主要程式
```bash
python incremental_learning.py
```

### 輸出檔案
- `submission.csv`: 最終預測結果 (4,780個帳戶)
- 格式: `acct,label` (0=正常, 1=警示)

## 📊 性能目標

| 指標 | 當前值 | 目標值 |
|------|--------|--------|
| F1-score | 0.1335 | 0.3-0.4 |
| 預測警示比例 | 42.74% | 0.1-1% |
| Precision | ~0.005 | 0.3-0.5 |
| Recall | 未知 | 0.5-0.7 |

## 🔧 技術細節

### 資料規模
- **交易記錄**: 4,435,890 筆
- **正常帳戶**: 1,794,322 個（可用於訓練）
- **已知警示帳戶**: 1,500 個
- **需預測帳戶**: 4,780 個

### 記憶體優化
- 批次處理避免記憶體溢出
- 交叉驗證減少重複訓練
- 特徵工程按需計算

## 📝 關鍵發現

1. **類別極度不平衡**: 真實警示帳戶比例僅 0.1%
2. **Random Forest 過度預測**: 在極度不平衡時表現差
3. **特徵工程有效**: EDA 發現的特徵確實有區分度
4. **無監督學習更適合**: Isolation Forest 等模型更適合異常檢測

## 🎯 下一步行動

1. ✅ 實施策略 1: 降低訓練比例到 0.1%
2. ✅ 實施策略 2: 移除類別權重平衡
3. ✅ 實施策略 3: 調整 Random Forest 參數
4. ✅ 實施策略 4: 增加訓練樣本到 10000
5. ⏳ 測試並選擇最佳策略組合
6. ⏳ 重新訓練並評估 F1-score

## 💪 持續改善中！

**目標**: 將 F1-score 從 0.1335 提升到 0.3 以上！
