# 金融交易異常檢測系統

## 🎯 專案目標
從龐大且關係複雜的轉帳交易資料中，找出不合理的交易模式，分析交易時間線、金額以及交易對手，預測未來會被判定為警示的帳戶。

## 📊 評估指標
- **F1-score**: 主要評估指標
- **TP (True Positive)**: 該帳戶實際為警示帳戶，預測為警示帳戶
- **FN (False Negative)**: 該帳戶實際為警示帳戶，預測為正常帳戶  
- **FP (False Positive)**: 該帳戶實際為正常帳戶，預測為警示帳戶
- **TN (True Negative)**: 該帳戶實際為正常帳戶，預測為正常帳戶

## 🏗️ 系統架構

### 核心模組
- `data_loader.py`: 資料載入與預處理
- `alert_focused_feature_engineering.py`: 警示帳戶特徵工程
- `incremental_learning.py`: 增量學習主程式（主要執行檔）

### 資料檔案
- `data/acct_alert.csv`: 已知警示帳戶標籤 (1,500個)
- `data/acct_predict.csv`: 需要預測的帳戶 (4,780個)
- `data/acct_transaction.csv`: 交易記錄 (4,435,890筆)

## 🔄 增量學習邏輯

### 1. 訓練資料創建
```python
# 當前設定 (v2.0)
alert_ratio=0.01        # 1% 警示帳戶（平衡學習和真實性）
sample_size=5000        # 5000 個訓練樣本
strategy='representative'  # 代表性採樣：確保涵蓋不同交易模式
```

**採樣策略**：
- **警示帳戶**: 採樣 50 個 (1%)
- **正常帳戶**: 採樣 4,950 個 (99%)
- **代表性採樣**: 從 1,794,322 個正常帳戶中，按交易金額分組，確保涵蓋不同交易模式

### 2. 模型訓練與比較
系統會訓練以下模型並比較其 F1-score：
- **Random Forest**: 監督學習，使用交叉驗證
- **Isolation Forest**: 無監督異常檢測
- **One-Class SVM**: 無監督學習
- **LOF**: 基於密度的異常檢測
- **DBSCAN**: 聚類異常檢測

### 3. 最佳模型選擇
- 使用已知標籤資料（5000個樣本）進行模型比較
- 選擇 F1-score 最高的模型
- 用此模型預測所有未標籤帳戶

### 4. 批次預測
- 將 4,780 個預測帳戶分批處理
- 每批 1,000 個帳戶（記憶體管理）
- 確保 100% 覆蓋率

## 🎯 特徵工程

### 警示帳戶導向特徵（從 EDA 發現）
- **時間特徵**: 
  - 週末交易比例、夜間交易比例
  - 交易間隔變異性（警示帳戶間隔更不規則）
- **金額特徵**: 
  - 相同金額頻率（警示帳戶常有重複金額）
  - 金額標準差、最大最小金額
- **對手特徵**: 
  - 轉入多樣性（警示帳戶轉入對手少）
  - 獨特交易對手數量
- **行為特徵**: 
  - 交易頻率、交易模式
  - 異常檢測分數
- **風險特徵**: 
  - 綜合風險評分

## 📈 版本演進

### v1.0 (初始版本)
- **F1-score**: 0.1335
- **問題**: 預測過多警示帳戶 (42.74%)
- **原因**: 訓練比例過高 (10%)，無監督模型閾值過低

### v2.0 (當前版本)
- **F1-score**: 0.1734 (提升 30%)
- **改善**: 平衡訓練比例 (1%)，優化模型參數
- **狀態**: 持續改善中

### v3.0 (目標版本)
- **目標 F1-score**: 0.3-0.4
- **策略**: 進一步優化特徵工程和模型選擇

### 🚨 當前表現 (v2.0)
- **F1-score**: 0.1734（系統評測）- 比 v1.0 的 0.1335 提升 30%
- **預測比例**: 待確認
- **真實比例**: 約 0.1% 警示帳戶
- **狀態**: 持續改善中，目標 F1-score 0.3-0.4

### 💡 改善策略

#### 策略 1: 平衡訓練比例 🎯
```python
alert_ratio=0.01  # 1% 警示帳戶（平衡學習和真實性）
```
- **原因**: 在真實比例 0.1% 和學習效果間找到平衡
- **效果**: 提供足夠的警示帳戶樣本供學習

#### 策略 2: 重新啟用類別權重平衡 ⚖️
```python
# Random Forest 使用 class_weight='balanced'
# 平衡極度不平衡的類別分布
```
- **原因**: 在極度不平衡時需要類別權重
- **效果**: 讓模型重視少數類（警示帳戶）

#### 策略 3: 調整模型參數 🔧
```python
# Random Forest 參數 (v2.0)
n_estimators=100     # 適中數量
max_depth=5          # 適中深度
min_samples_leaf=5   # 適中限制
class_weight='balanced'  # 啟用類別權重
```
- **原因**: 平衡模型複雜度和學習能力
- **效果**: 有足夠能力學習複雜模式

#### 策略 4: 優化無監督學習閾值 🤖
```python
# 無監督模型參數 (v2.0)
contamination=0.1    # 10% 異常比例（平衡學習）
nu=0.1              # 10% 異常比例（平衡學習）
```
- **原因**: 提供合理的異常檢測閾值
- **效果**: 避免所有帳戶都被標記為異常

#### 策略 5: 多模型動態選擇 🎯
- **Random Forest**: 監督學習，使用類別權重
- **Isolation Forest**: 無監督異常檢測，contamination=0.1
- **One-Class SVM**: 無監督學習，nu=0.1
- **LOF**: 基於密度，contamination=0.1
- **DBSCAN**: 聚類異常檢測
- **原因**: 不同模型適合不同情況
- **效果**: 動態選擇最佳模型

## 🚀 執行方式

### 主要程式
```bash
python incremental_learning.py
```

### 輸出檔案
- `submission.csv`: 最終預測結果 (4,780個帳戶)
- 格式: `acct,label` (0=正常, 1=警示)

## 📊 性能目標

| 指標 | v1.0 | v2.0 (當前) | 目標值 |
|------|------|-------------|--------|
| F1-score | 0.1335 | 0.1734 | 0.3-0.4 |
| 預測警示比例 | 42.74% | 待確認 | 0.1-1% |
| Precision | ~0.005 | 待確認 | 0.3-0.5 |
| Recall | 未知 | 待確認 | 0.5-0.7 |

## 🔧 技術細節

### 資料規模
- **交易記錄**: 4,435,890 筆
- **正常帳戶**: 1,794,322 個（可用於訓練）
- **已知警示帳戶**: 1,500 個
- **需預測帳戶**: 4,780 個

### 記憶體優化
- 批次處理避免記憶體溢出
- 交叉驗證減少重複訓練
- 特徵工程按需計算

## 📝 關鍵發現

1. **類別極度不平衡**: 真實警示帳戶比例僅 0.1%
2. **Random Forest 過度預測**: 在極度不平衡時表現差
3. **特徵工程有效**: EDA 發現的特徵確實有區分度
4. **無監督學習更適合**: Isolation Forest 等模型更適合異常檢測

## 🎯 下一步行動 (v3.0)

1. ✅ v1.0: 識別問題 - 過度預測警示帳戶
2. ✅ v2.0: 平衡參數 - 調整訓練比例和模型參數
3. ⏳ v3.0: 特徵優化 - 進一步改善特徵工程
4. ⏳ v3.0: 模型調優 - 超參數優化
5. ⏳ v3.0: 集成學習 - 多模型融合
6. ⏳ v3.0: 閾值調整 - 動態調整預測閾值

## 💪 持續改善中！

**v2.0 成果**: F1-score 從 0.1335 提升到 0.1734 (提升 30%)
**v3.0 目標**: 將 F1-score 提升到 0.3 以上！
